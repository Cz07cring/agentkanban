# 根目录图片需求对照评审（当前方案正确性 + 优化建议）

## 1. 评审范围

对照根目录图片与文档中描述的目标，检查当前代码是否落地：

- `640 (2).png`：多实例并行开发（Git worktree）与共享文件策略
- `640 (3).png`：冲突处理（rebase 失败 / 测试失败）闭环
- `640 (5).png`：任务管理中心看板 UI
- `640 (6).png`：Plan 模式审批问答面板
- `640 (7).png`：移动端录音输入栏与 tabs 布局

并给出“当前方案是否正确”的判断与更优方案。

---

## 2. 结论先行

**当前方案方向是对的，但实现上属于“70 分可运行版”，与图片目标相比还有关键缺口。**

- ✅ 已有：多 worker、任务路由、Plan 审批、看板、实时更新、基础 worktree 自动创建。
- ⚠️ 缺口：worktree 的共享文件策略（symlink 白名单/黑名单）尚未形成工程化约束；冲突处理以 merge 为主，和图片强调的 rebase 闭环不完全一致；Plan 审批 UI 只有基础“通过/驳回”，未实现图片中的结构化问答确认；移动端“录音条固定在 tabs 上方”的文档编辑场景还没有完整产品形态。

因此：

- **如果你的目标是“AI 开发任务中台”**：当前方案基本正确，可迭代增强。
- **如果你的目标是“图片里那套 CEO 文档工作台”**：当前项目还不完整，需要补齐产品边界与交互域模型。

---

## 3. 图片逐项对照

## 3.1 `640 (2).png` 多实例并行 + worktree 共享策略

### 现状

- 后端已实现 worker 池，并在运行时为 worker 创建/校验 git worktree，任务前准备 task 分支。见 `_ensure_worktree` 与 `_prepare_worktree_for_task`。  
- 也定义了多引擎 worker（Claude 5200-5202 / Codex 5203-5204）。

### 差距

- 图片强调“仅共享 data、锁、key，禁止共享 PROGRESS.md”。当前实现并未看到显式 symlink 白名单/黑名单治理。
- 当前任务完成后主分支整合逻辑是 `_merge_task_branch`（`git merge --no-ff`），并非图片中强调的“先 rebase 再继续”的标准闭环。

### 判断

- **并行执行能力：正确。**
- **版本治理策略：部分正确（缺治理细则）。**

---

## 3.2 `640 (3).png` 冲突处理（rebase/test fail）

### 现状

- 代码有失败重试、心跳、健康检查、失败计数与恢复机制。
- 但“rebase 失败标准流程（stash/解冲突/rebase --continue）”主要存在于系统设计文档，并未形成强制执行器。

### 差距

- 缺少一个可程序化执行并可审计的 GitOps 步骤机（例如 pre-merge fetch/rebase/test gate）。
- 缺少任务级“测试必须通过才能推进”的硬门禁（当前更偏运行时状态流转，不是质量闸门流）。

### 判断

- **方向正确，但自动化深度不够。**

---

## 3.3 `640 (5).png` 任务管理中心看板

### 现状

- 前端已有任务看板、统计、状态列（含 `plan_review`）、任务详情与实时 WS 更新。
- 有任务创建、状态流转、手动 dispatch/retry/review 触发。

### 差距

- 视觉和交互细节与图片存在差异（图片更偏浅色、密集卡片和“任务中心”产品态）。
- 当前 UI 更像“工程运维看板”，不是“个人工作流中心”深度场景。

### 判断

- **功能骨架正确，产品层细节尚未对齐图片范式。**

---

## 3.4 `640 (6).png` Plan 模式审批问答

### 现状

- Plan 任务已进入 `plan_review`，并支持审批通过/驳回。
- 后端已有 plan 生成 prompt 与审批后自动拆解子任务机制。

### 差距

- 图片展示的是“结构化问题确认卡片（数据源/频率/通知方式等）+ 一键确认创建”。当前主要是文本计划 + 审批，没有形成可复用的“参数化决策表单”。

### 判断

- **已实现 Plan 审批主链路，但未实现结构化意图确认层。**

---

## 3.5 `640 (7).png` 手机端录音条 + tabs

### 现状

- 已有语音输入组件（浏览器语音识别）并接入任务创建表单。

### 差距

- 图片是文档编辑器场景（主 tabs + sub-tabs + 录音条固定位置），当前项目主要是 Kanban 管理，不是完整文档编辑工作台。

### 判断

- **“有语音能力”是正确方向；“移动端文档编辑交互形态”尚未落地。**

---

## 4. 当前方案是否正确（总评）

**正确，但不是终态。**

可归类为：

1. **调度中台层**（当前已较完整）：任务、状态机、路由、worker、健康检查。
2. **生产工作台层**（当前不完整）：结构化 Plan 问答、文档编辑多域 tabs、移动端录音交互规则。
3. **工程治理层**（当前有缺口）：rebase-first、测试门禁、共享文件策略的可执行约束。

---

## 5. 更好的方案（建议采用）

## 方案 A：保守增强（推荐，2~4 周）

在当前仓库基础上做三件事：

1. **GitOps 强化**
   - 每个任务合并前固定流水：`fetch -> rebase main -> test -> merge`。
   - 冲突时生成结构化诊断（冲突文件、建议动作、是否需要人工介入）。
   - 将“不要放弃”改为系统策略（最多 N 次自动修复 + 升级告警）。

2. **Plan 问答层**
   - 在 `plan_review` 阶段引入 schema（如：数据源、刷新频率、通知策略、性能目标）。
   - 审批页从“纯文本”升级为“文本计划 + 参数表单”。

3. **共享文件治理**
   - 增加 worktree 初始化器：自动建立允许共享的 symlink 列表。
   - 增加禁止共享扫描器（如 PROGRESS.md）并在调度前校验。

适用：你希望尽快可用，同时把稳定性和可解释性拉到生产级。

## 方案 B：双产品架构（中期，4~8 周）

将系统显式拆分：

- **Agent Kanban（中台）**：任务调度、引擎治理、审计事件。
- **CEO Workspace（前台）**：文档编辑、语音输入、多 tabs、翻译与格式规范。

二者通过 API/事件总线联动：Workspace 产生需求 -> Kanban 执行 -> 结果回写 Workspace。

适用：你要真正对齐图片中的“个人工作台”长期路线。

---

## 6. 建议你现在就做的最小闭环（MVP+）

按优先级：

1. **先补 GitOps 门禁（最高优先）**：保证并行开发不因版本冲突失控。  
2. **再补 Plan 参数化审批**：减少需求偏差，提升一次成功率。  
3. **最后补移动端文档交互**：把语音能力从“输入插件”升级为“流程入口”。

这样可在不推翻现有代码的前提下，把“可运行”提升到“可规模化稳定运行”。
