# 业务全链路评估（从项目发起 → 项目分析 → 任务分发 → 执行交付）

## 1. 评估结论（先看）

从“用户视角”评估当前系统：

- **主链路可跑通**：可以创建项目、创建任务、调度执行、Plan 审批、分解子任务、重试与 Review。  
- **业务完备度约 80%**：已具备可用性，但在“生产级业务治理”上仍有关键缺口。  
- **核心问题不在功能有没有，而在业务约束不足**：例如幂等、审批门禁、失败分层、风险操作防呆、跨项目一致性。

---

## 2. 用户全流程拆解与现状

## 阶段 A：发起项目（Onboarding）

### 现有能力
- 支持项目创建、更新、删除，并有仓库合法性校验。  
- 新增了 `validate-repo` 预校验与项目名/仓库路径唯一性检查。  

### 已看到的业务缺口
1. **缺“项目模板初始化”**：创建项目后没有自动注入默认流程（任务模板、告警阈值、默认策略）。
2. **权限模型缺失**：当前是单用户逻辑，缺“谁能创建/删除项目”的业务边界。
3. **删除治理不足**：删除项目仍偏硬删除语义，缺软删除+恢复窗口（高风险）。

---

## 阶段 B：项目分析（Plan / 需求澄清）

### 现有能力
- Plan 任务进入 `plan_review`，可审批并自动分解子任务。

### 已看到的业务缺口
1. **审批语义不够强**：驳回后直接回 `pending`，但缺“必须补充参数后再进入调度”的硬门禁。
2. **计划质量门禁不足**：`_decompose_from_plan` 生成子任务后缺校验（是否覆盖验收标准/测试项）。
3. **无计划版本化**：plan 被驳回多轮后缺显式版本和差异对比（影响可追溯）。

---

## 阶段 C：任务分发（Dispatch）

### 现有能力
- 调度循环、依赖检查、优先级排序、引擎 fallback、Worker 健康检查已经具备。

### 已看到的业务缺口
1. **缺业务 SLA 规则**：目前按优先级分发，但没有“超时升级策略/项目级配额”。
2. **缺调度公平性控制**：多项目下无明确防饥饿策略（可能长期偏向高优先级项目）。
3. **fallback 的质量边界缺少策略**：功能任务可 fallback，但未按任务风险等级做差异化限制。

---

## 阶段 D：执行与失败恢复

### 现有能力
- 支持重试、错误日志、attempt/timeline 记录。

### 已看到的业务缺口
1. **失败分类不够业务化**：当前失败多是技术状态，缺“可自动修复 / 需人工介入 / 需产品决策”分层。
2. **自动重试策略较粗**：缺按错误类别动态退避（例如权限错误不应盲重试）。
3. **回滚策略未产品化**：当子任务批量失败时，缺“整单回滚/暂停分发”机制。

---

## 阶段 E：Review 与交付

### 现有能力
- 有 Review 子任务与结构化结果承接。

### 已看到的业务缺口
1. **通过标准不清晰**：Review completion 到最终“可交付”之间缺显式质量阈值（critical/high 数量门禁）。
2. **交付状态与用户可见结果脱节**：缺“业务验收通过”这一层，不仅是代码完成。
3. **缺用户通知分级**：关键事件（审批、失败、回滚）没有按优先级分发到移动端通知策略。

---

## 3. “代码未考虑到位”的关键清单（你最关心）

1. **创建项目后无业务初始化**（模板、策略、告警阈值）→ 上线后每个项目要人工补配。  
2. **Plan 审批缺硬门禁与版本管理** → 多轮沟通成本高，追溯弱。  
3. **调度缺项目级公平性与 SLA** → 高优先级项目容易长期挤占资源。  
4. **重试/失败缺业务语义分层** → 处理动作无法标准化。  
5. **删除/高风险操作防呆不够** → 误操作风险仍偏高。  
6. **交付定义偏技术态**（completed/reviewed）缺业务验收态。  

---

## 4. 优化优先级（从“最影响生产”开始）

## P0（1 周，必须做）
1. 项目初始化模板（创建后自动生成默认策略配置）。
2. Plan 审批硬门禁（参数不完整不能进入 pending）。
3. 删除项目改软删除（含恢复窗口）。

## P1（1~2 周）
1. 调度公平性策略（按项目配额 + aging）。
2. 失败分类与重试矩阵（error class -> action）。
3. Review 到交付增加质量阈值门禁。

## P2（2~4 周）
1. 业务验收状态层（如 `accepted` / `rejected_by_business`）。
2. 移动端分级通知策略（普通/警告/紧急）。
3. 审计报表（项目维度吞吐、失败率、回滚率、Lead Time）。

---

## 5. 建议的业务目标指标（用于判断是否“真的优化到了”）

1. 项目创建到首任务可执行时间（TTV） <= 5 分钟。  
2. Plan 一次审批通过率 >= 70%。  
3. 任务失败后自动恢复成功率 >= 85%。  
4. 高优先任务 P95 等待时长下降 30%。  
5. 误删/误操作工单数下降 80%。

---

## 6. 与当前代码映射（证据）

- 项目创建与校验：`create_project`、`update_project`、`validate_project_repo`。  
- Plan 审批与自动分解：`_approve_plan_impl` / `_decompose_task_impl`。  
- 调度核心：`DispatchRuntime._dispatch_for_project`（依赖、优先级、fallback）。  
- 前端任务面板与动作入口：`TasksPage`、`TaskDetailPanel`（重试/分配/触发 Review）。

> 以上映射说明：当前代码主链路完整，但业务治理层还需要“强约束 + 指标化”。

