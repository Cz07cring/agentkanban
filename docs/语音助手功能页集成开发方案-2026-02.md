# 语音助手在功能页集成开发方案（先方案后开发）

## 1. 背景与目标

你当前的核心诉求不是“在新建需求页面再加一个语音输入框”，而是：

- 在**日常功能页面**里随时可唤起语音助手；
- 通过自然语言口述需求、补充上下文、更新任务；
- 用更少输入完成“记录 -> 结构化 -> 下发”的闭环。

本方案聚焦“轻交互、低打扰、可随时触发”的产品形态，避免再次回到复杂表单模式。

---

## 2. 产品范围（MVP）

### 2.1 In Scope（本轮做）

1. **全局语音助手入口（功能页级）**
   - 在 Console 主体页面（如 tasks/projects）提供固定入口按钮（右下角悬浮）。
   - 支持点击打开语音助手抽屉（或底部面板）。

2. **语音转写 + 实时编辑**
   - 支持开始/暂停录音。
   - 识别文本实时显示，可手工编辑后再提交。

3. **两种提交模式**
   - 快速记录：仅保存为“语音笔记/待处理输入”。
   - 结构化生成：调用后端接口，把语音文本转换为“目标、约束、验收标准、建议行动”。

4. **多轮澄清（选择题优先）**
   - AI 返回 2~4 个关键问题（单选/多选优先，文本补充可选）。
   - 用户点选后再次生成收敛版本。

5. **一键分发到现有流程**
   - 直接生成 Task（plan_mode 可选）或追加到现有任务备注。

### 2.2 Out of Scope（本轮不做）

- 真正实时双向语音对话（TTS 播报 + 语音打断）可放 P1。
- 多人协作审批流（你当前是单用户场景，不强加审批人/决策理由）。
- 外部 IM/电话渠道接入。

---

## 3. 交互设计（重点：简单、可持续使用）

### 3.1 入口策略

- 每个功能页右下角展示统一按钮：`🎤 语音助手`。
- 移动端采用底部悬浮圆按钮，避开已有核心操作按钮区域。
- 支持快捷键（Web）：`Alt + V` 打开/关闭。

### 3.2 面板结构（由上到下）

1. **状态栏**：麦克风状态、识别语言、网络状态。
2. **转写区**：实时转写文本，可直接修改。
3. **AI建议区**：
   - 自动提炼“我理解你的需求是：xxx”；
   - 给出 2~3 个下一步动作按钮。
4. **关键问题区（选择题）**：
   - 每次最多 3 题，避免复杂；
   - 默认选项 + “其他（自定义）”。
5. **提交区**：
   - `保存为笔记`
   - `生成任务草案`
   - `追加到当前任务`

### 3.3 体验原则

- 先语音，后结构化；
- 先选择题，后自由编辑；
- 单屏可完成，不强迫跳转新建页。

---

## 4. 技术方案

### 4.1 前端架构

新增组件建议：

- `frontend/src/components/VoiceAssistantLauncher.tsx`
- `frontend/src/components/VoiceAssistantPanel.tsx`
- `frontend/src/components/VoiceAssistantQuestionnaire.tsx`

接入位置：

- `frontend/src/app/(console)/layout.tsx` 或公共 shell，保证功能页全局可用。

依赖复用：

- 复用现有 `VoiceInput` 能力（录音/识别基础）。
- 抽离为 hook：`useVoiceAssistantSession()` 管理状态机。

### 4.2 状态机（建议）

`idle -> listening -> transcribing -> clarifying -> drafting -> done/error`

- listening：录音中；
- transcribing：语音转文字处理中；
- clarifying：等待用户回答 AI 问题；
- drafting：根据答案生成任务草案；
- done/error：完成或失败。

### 4.3 后端接口（新增）

1. `POST /api/voice-assistant/parse`
   - 输入：`raw_text`, `context(project_id, task_id, page)`
   - 输出：`summary`, `intent`, `candidate_actions`, `questions[]`

2. `POST /api/voice-assistant/refine`
   - 输入：`raw_text`, `answers[]`, `context`
   - 输出：`draft`（结构化任务草案）

3. `POST /api/voice-assistant/commit`
   - 输入：`mode(note|task|append)`, `draft`, `target`
   - 输出：`created_id`, `result`

> 容器环境下可继续本地 fallback；真实环境切换专属 AI API。

---

## 5. 数据结构草案

```json
{
  "session_id": "va_xxx",
  "raw_text": "用户原始语音转写",
  "summary": "AI提炼的一句话",
  "intent": "create_task | refine_plan | append_note",
  "questions": [
    {
      "id": "q1",
      "title": "你更偏向哪种交付节奏？",
      "type": "single",
      "options": ["今天可用", "本周稳定", "两周完整"]
    }
  ],
  "answers": [
    {"question_id": "q1", "value": "本周稳定"}
  ],
  "draft": {
    "title": "...",
    "description": "...",
    "acceptance_criteria": ["..."],
    "risk_level": "medium"
  }
}
```

---

## 6. 与现有业务流程衔接

- 若 `mode=task`：走现有创建任务 API，并支持 `plan_mode`。
- 若 `mode=append`：追加到任务时间线/备注，不打断执行态。
- 若 `mode=note`：进入“待处理输入箱”，后续可再结构化。

这能保证你在任意页面“想到就说”，同时不破坏已有任务体系。

---

## 7. 风险与规避

1. **语音识别误差**
   - 规避：提交前必须可编辑；关键字段二次确认。

2. **问题过多造成负担**
   - 规避：单轮最多 3 题，且优先选择题。

3. **AI结果不稳定（容器环境）**
   - 规避：标记响应来源 `ai_local_fallback`；支持重生成。

4. **移动端误触与遮挡**
   - 规避：悬浮按钮支持拖拽/自动避让底部主操作区。

---

## 8. 开发排期（建议）

### P0（2~3天）

- 全局入口 + 语音面板 UI；
- 语音转写文本可编辑；
- 快速记录（note）链路打通。

### P1（3~5天）

- `/parse` + `/refine` 接口；
- 多轮选择题澄清；
- 生成任务草案并提交。

### P2（2~3天）

- 追加到现有任务；
- 快捷键、移动端交互优化；
- 埋点与质量指标。

---

## 9. 验收标准（你可直接审批）

1. 在 tasks/projects 页面无需跳转即可打开语音助手。
2. 语音输入后 5 秒内能看到转写文本（可编辑）。
3. AI 问题不超过 3 个且可选答。
4. 可将结果一键变成任务草案并创建成功。
5. 容器环境与真实环境能通过配置切换，且来源可识别。

---

## 10. 端到端测试计划（开发后执行）

1. 打开任务页 -> 点击语音助手 -> 录入文本（模拟）。
2. 调用 `/parse` 返回问题与建议动作。
3. 选择答案 -> 调用 `/refine` 生成草案。
4. 提交 `/commit` 创建任务。
5. 在任务列表与详情页验证数据一致。
6. 移动端视口回归：按钮不遮挡主要操作。

---

## 11. 本次结论

该方案满足你的最新要求：

- 语音助手在**功能页面直接使用**；
- 你只需口述与选择，不被复杂文案绑架；
- AI 负责生成问题与方案，你负责快速决策；
- 先给开发方案，确认后再进入编码与 E2E。
